# Анализ проблемы: Почему бот не запрашивает разрешение на отправку сообщений

## Важно понимать

**Системное уведомление VK о запросе разрешения НЕ контролируется кодом бота.** Это автоматическое поведение VK, которое появляется при определенных условиях.

## Как это работает в VK

1. **Системное уведомление появляется автоматически**, когда:
   - Пользователь открывает диалог с сообществом (https://vk.me/atservice_official)
   - Пользователь **еще НЕ разрешил** сообществу писать ему
   - В настройках Long Poll API включено событие "Разрешение на получение"

2. **Бот НЕ может запросить разрешение программно** - это делает только VK автоматически

3. **Бот может только ОБРАБАТЫВАТЬ** событие `MESSAGE_ALLOW`, когда пользователь нажимает "Разрешить"

## Почему уведомление может не появляться

### 1. Событие не включено в Long Poll API
**Решение:**
- Открой https://vk.com/atservice_official
- Управление → Настройки → Работа с API
- В разделе "События" включи: **"Разрешение на получение (MESSAGE_ALLOW)"**

### 2. Пользователь уже разрешил ранее
**Решение:**
- Проверь с другого аккаунта (не подписанного на сообщество)
- Или открой в режиме инкогнито

### 3. Настройки сообщества
**Проверь:**
- Управление → Настройки → Сообщения
- "Сообщения сообщества" должны быть включены

## Что делает бот

Бот обрабатывает событие `MESSAGE_ALLOW` в функции `handle_message_allow()`:

```python
@bot.on.raw_event(GroupEventType.MESSAGE_ALLOW)
async def handle_message_allow(event):
    # Когда пользователь нажимает "Разрешить" в системном уведомлении VK,
    # VK отправляет событие MESSAGE_ALLOW в Long Poll API
    # Бот получает это событие и отправляет приветственное сообщение
```

## Диагностика

### Проверка настроек VK:
1. Запусти на VPS: `python3 check_vk_settings.py`
2. Проверь логи бота: `journalctl -u bot-vk.service -f`
3. Ищи в логах: `[MESSAGE_ALLOW]` - если видишь, значит событие приходит

### Проверка работы:
1. Открой https://vk.me/atservice_official с **другого аккаунта**
2. Должно появиться системное уведомление: "Приложение запрашивает разрешение..."
3. Нажми "Разрешить"
4. В логах бота должно появиться: `[MESSAGE_ALLOW] ✅ ПОЛУЧЕНО СОБЫТИЕ РАЗРЕШЕНИЯ`

## Решение проблемы

### Шаг 1: Проверь настройки Long Poll API
```
https://vk.com/atservice_official
→ Управление → Настройки → Работа с API
→ События:
   ✅ Входящее сообщение
   ✅ Разрешение на получение (MESSAGE_ALLOW) ← ОБЯЗАТЕЛЬНО!
```

### Шаг 2: Проверь с нового аккаунта
- Создай тестовый аккаунт или используй другой
- Открой https://vk.me/atservice_official
- Должно появиться системное уведомление

### Шаг 3: Проверь логи бота
```bash
journalctl -u bot-vk.service -f
```

При разрешении должно появиться:
```
[MESSAGE_ALLOW] ✅ ПОЛУЧЕНО СОБЫТИЕ РАЗРЕШЕНИЯ
[WELCOME] Отправка приветствия пользователю <id>
```

## Вывод

**Бот работает правильно.** Проблема в настройках VK:
- Событие "Разрешение на получение" должно быть включено в Long Poll API
- Системное уведомление появляется автоматически VK, не контролируется кодом
- Бот только обрабатывает событие, когда пользователь разрешает
